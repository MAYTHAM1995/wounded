<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نموذج إدخال بيانات الجريح والعائلة</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#0b5ed7;--ok:#198754;--warn:#ffc107;--danger:#dc3545;--bg:#f5f7fb;}
    *{box-sizing:border-box}
    body{font-family:'Cairo',sans-serif;background:var(--bg);margin:0;color:#111}
    header{background:var(--brand);color:#fff;padding:12px 16px;text-align:center;font-weight:700}
    .wrap{max-width:1200px;margin:16px auto;padding:12px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;background:#e7f0ff;color:#0b5ed7;border:1px solid #bcd3ff;cursor:pointer;user-select:none}
    .tab.active{background:#0b5ed7;color:#fff;border-color:#0b5ed7}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    label{display:block;font-size:13px;color:#333;margin-bottom:4px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #ccd3da;border-radius:10px;background:#fff}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{font-size:12px;background:#eef2ff;color:#333;border:1px solid #cdd7ff;padding:4px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;margin-top:12px}
    button{padding:8px 12px;border-radius:10px;border:1px solid #cfd8e3;background:#fff;cursor:pointer}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    button.success{background:var(--ok);border-color:var(--ok);color:#fff}
    button.warn{background:var(--warn);border-color:var(--warn)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    th,td{border:1px solid #e5e7eb;padding:6px 8px}
    th{background:#f3f4f6}
    .sticky-head{position:sticky;top:0;z-index:2}
    .muted{color:#6b7280;font-size:13px}
    .footer{text-align:center;color:#6b7280;font-size:12px;margin-top:18px}
  </style>
</head>
<body>
  <header>نموذج إدخال بيانات الجريح والعائلة</header>
  <div class="wrap">
    <div class="tabs">
      <div class="tab active" data-tab="wounded">بيانات الجريح</div>
      <div class="tab" data-tab="family">بيانات العائلة</div>
      <div class="tab" data-tab="export">حفظ/استرجاع</div>
    </div>

    <section class="card" id="tab-wounded">
      <div class="row"><span class="pill">مصدر الحقول: جرحى2025.xlsx</span></div>
      <div class="grid" id="wounded-grid">
        <!-- Wounded fields -->
      </div>
      <div class="actions">
        <button class="success" id="save-wounded">إضافة إلى قائمة الجرحى</button>
        <span class="muted">تُحفظ البيانات مؤقتاً في المتصفح.</span>
      </div>
      <div class="card" style="margin-top:10px">
        <table id="wounded-table">
          <thead class="sticky-head"></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card" id="tab-family" style="display:none">
      <div class="row"><span class="pill">مصدر الحقول: وليد خالد.xlsx</span>
        <span class="muted">أضف صف لكل فرد من العائلة.</span>
      </div>
      <div class="actions">
        <button class="primary" id="add-family-row">إضافة فرد</button>
      </div>
      <div class="card" style="margin-top:10px">
        <table id="family-table">
          <thead class="sticky-head"></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card" id="tab-export" style="display:none">
      <div class="row" style="gap:16px">
        <div>
          <h3>ملفات CSV</h3>
          <div class="actions">
            <button id="download-wounded">تنزيل الجرحى.csv</button>
            <button id="download-family">تنزيل العائلة.csv</button>
          </div>
          <p class="muted">الملفات تُفتح في Excel أو Google Sheets.</p>
        </div>
        <div>
          <h3>استرجاع بيانات</h3>
          <div class="actions">
            <label>تحميل الجرحى CSV<input type="file" id="upload-wounded" accept=".csv"></label>
            <label>تحميل العائلة CSV<input type="file" id="upload-family" accept=".csv"></label>
          </div>
        </div>
        <div>
          <h3>الحفظ التلقائي</h3>
          <div class="row">
            <button id="clear-cache" class="warn">مسح الحفظ المؤقت</button>
          </div>
          <p class="muted">توجد نسخة في التخزين المحلي للمتصفح.</p>
        </div>
      </div>
    </section>

    <div class="footer">الإصدار المبدئي. يمكن تعديل الحقول لاحقاً حسب الحاجة.</div>
  </div>

  <script>
    const WOUNDED_FIELDS = [{"label": "ت", "id": "f__"}, {"label": "اسم الجريح", "id": "f__"}, {"label": "نسبة العجز", "id": "f__"}, {"label": "اسم الام", "id": "f__"}, {"label": "القضاء", "id": "f__"}, {"label": "الناحية / الحي", "id": "f__"}, {"label": "نقطة دالة", "id": "f__"}, {"label": "رقم الهاتف", "id": "f__"}, {"label": "الحالة الاجتماعية", "id": "f__"}, {"label": "اسم الزوجة", "id": "f__"}, {"label": "نوع السكن", "id": "f__"}, {"label": "معاملة الجريح التقاعدية منجزة؟", "id": "f__"}, {"label": "مستلم منحة وزارة النفط", "id": "f__"}, {"label": "تاريخ الاستلام", "id": "f__"}, {"label": "المبلغ", "id": "f__"}, {"label": "التحصيل الدراسي", "id": "f__"}, {"label": "عدد الاولاد", "id": "f__"}, {"label": "عدد البنات", "id": "f__"}, {"label": "الكلي", "id": "f__"}];
    const FAMILY_FIELDS  = [{"label": "ت", "id": "f_family__"}, {"label": "اسم المستفيد", "id": "f_family__"}, {"label": "اسم الجريح", "id": "f_family__"}, {"label": "تاريخ الولادة", "id": "f_family__"}, {"label": "محل  الولادة", "id": "f_family__"}, {"label": "الصلة", "id": "f_family__"}, {"label": "رقم الهاتف", "id": "f_family__"}, {"label": "الحالة الاجتماعية", "id": "f_family__"}, {"label": "المحافظة", "id": "f_family__"}, {"label": "القضاء", "id": "f_family__"}, {"label": "المنطقة", "id": "f_family__"}, {"label": "نقطة دالة", "id": "f_family__"}, {"label": "الحالة الحياتية", "id": "f_family__"}, {"label": "مستمر في الدراسة", "id": "f_family__"}, {"label": "التحصيل الدراسي", "id": "f_family__"}, {"label": "اخر مرحلة دراسية", "id": "f_family__"}, {"label": "اسم المدرسة/الجامعة", "id": "f_family__"}, {"label": "الاختصاص الدقيق", "id": "f_family__"}, {"label": "سبب الانقطاع عن الدراسة", "id": "f_family__"}, {"label": "المهنة", "id": "f_family__"}, {"label": "الرغبة في الدراسة", "id": "f_family__"}, {"label": "الهواية", "id": "f_family__"}, {"label": "المستوى الدراسي", "id": "f_family__"}, {"label": "الاحتياج التعليمي", "id": "f_family__"}, {"label": "الخدمات التعليمية المقدمة", "id": "f_family__"}, {"label": "مستلم منح تعليمية", "id": "f_family__"}, {"label": "المبلغ", "id": "f_family__"}, {"label": "الحالة الصحية", "id": "f_family__"}, {"label": "الاحتياجات الصحية", "id": "f_family__"}, {"label": "ما تم توفيره صحيا", "id": "f_family__"}, {"label": "الحالة المادية", "id": "f_family__"}, {"label": "ما تم توفيره ماديا", "id": "f_family__"}, {"label": "بطاقة السكن", "id": "f_family__"}, {"label": "اسم الام", "id": "f_family__"}, {"label": "النسب", "id": "f_family__"}, {"label": "قاصرين", "id": "f_family__"}, {"label": "ملاحظات عامة", "id": "f_family__"}, {"label": "الراصد/ة", "id": "f_family__"}, {"label": "نسبة العجز", "id": "f_family__"}];

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // Tabs
    $$('.tab').forEach(t=>t.onclick=()=>{ 
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const key = t.dataset.tab;
      ['wounded','family','export'].forEach(k=>$('#tab-'+k).style.display = (k===key)?'block':'none');
    });

    // Build wounded grid inputs
    const woundedGrid = $('#wounded-grid');
    function inputFor(f){
      const wrap = document.createElement('div');
      const isLong = /ملاحظات|وصف|احتياجات|عنوان|عنوان السكن|نقطة|تفاصيل/i.test(f.label);
      wrap.innerHTML = `
        <label for="${f.id}">${f.label}</label>
        ${isLong ? `<textarea id="${f.id}"></textarea>` : `<input id="${f.id}" type="text">`}
      `;
      return wrap;
    }
    WOUNDED_FIELDS.forEach(f=>woundedGrid.appendChild(inputFor(f)));

    // Table builders
    function buildHead(table, fields){
      const thead = table.querySelector('thead');
      thead.innerHTML = '<tr>'+fields.map(f=>`<th>${f.label}</th>`).join('')+'<th>إجراءات</th></tr>';
    }

    function addRow(table, fields, values={}){
      const tbody = table.querySelector('tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = fields.map(f=>`<td contenteditable="true" data-id="${f.id}">${values[f.id] ?? ''}</td>`).join('')
                  + `<td><button class="warn btn-del">حذف</button></td>`;
      tbody.appendChild(tr);
    }

    // Initialize tables
    const woundedTable = $('#wounded-table');
    const familyTable = $('#family-table');
    buildHead(woundedTable, WOUNDED_FIELDS);
    buildHead(familyTable,   FAMILY_FIELDS);

    // Save wounded form into table
    $('#save-wounded').onclick = ()=>{
      const values = {}
      WOUNDED_FIELDS.forEach(f=> values[f.id] = document.getElementById(f.id).value.trim());
      addRow(woundedTable, WOUNDED_FIELDS, values);
      persist();
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    };

    // Add family row
    $('#add-family-row').onclick = ()=>{ addRow(familyTable, FAMILY_FIELDS, {}); persist(); };

    // Row deletion
    document.addEventListener('click', (e)=>{ 
      if(e.target.classList.contains('btn-del')){ 
        e.target.closest('tr').remove(); 
        persist(); 
      }
    });

    // CSV helpers
    function tableToObjects(table, fields){
      return Array.from(table.querySelectorAll('tbody tr')).map(tr=>{
        const obj = {}
        fields.forEach((f,i)=>{
          const cell = tr.children[i];
          obj[f.label] = cell ? cell.textContent.trim() : '';
        })
        return obj;
      })
    }
    function downloadCSV(filename, rows){
      const headers = Object.keys(rows[0]||{});
      const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${(r[h]||'').replaceAll('"','""')}"`).join(','))).join('\\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    // Export buttons
    $('#download-wounded').onclick = ()=>{
      const rows = tableToObjects(woundedTable, WOUNDED_FIELDS);
      downloadCSV('الجرحى.csv', rows);
    }
    $('#download-family').onclick = ()=>{
      const rows = tableToObjects(familyTable, FAMILY_FIELDS);
      downloadCSV('العائلة.csv', rows);
    }

    // Import CSV
    function parseCSV(text){
      const [headerLine, ...lines] = text.split(/\\r?\\n/).filter(x=>x.trim().length>0);
      const headers = headerLine.split(',');
      const rows = lines.map(line=>{
        const cells = [];
        let cur=''; let inQ=false;
        for(let i=0;i<line.length;i++){ const ch=line[i];
          if(ch=='"'){ inQ=!inQ; continue; }
          if(ch==',' && !inQ){ cells.push(cur); cur=''; continue; }
          cur += ch;
        }
        cells.push(cur);
        const obj={};
        headers.forEach((h,idx)=> obj[h.replace(/^"|"$|\\uFEFF/g,'')] = (cells[idx]||'').replace(/^"|"$|\\uFEFF/g,''));
        return obj;
      });
      return rows;
    }

    function fillTableFromCSV(table, fields, rows){
      table.querySelector('tbody').innerHTML='';
      rows.forEach(r=>{
        const values={};
        fields.forEach(f=> values[f.id] = r[f.label]||'');
        addRow(table, fields, values);
      });
      persist();
    }

    $('#upload-wounded').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      file.text().then(t=> fillTableFromCSV(woundedTable, WOUNDED_FIELDS, parseCSV(t)));
    });
    $('#upload-family').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      file.text().then(t=> fillTableFromCSV(familyTable, FAMILY_FIELDS, parseCSV(t)));
    });

    // Local storage persistence
    function persist(){
      const data = {
        wounded: tableToObjects(woundedTable, WOUNDED_FIELDS),
        family:  tableToObjects(familyTable,  FAMILY_FIELDS)
      }
      localStorage.setItem('wf_cache', JSON.stringify(data));
    }
    function restore(){
      const raw = localStorage.getItem('wf_cache'); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(Array.isArray(data.wounded)) fillTableFromCSV(woundedTable, WOUNDED_FIELDS, data.wounded);
        if(Array.isArray(data.family))  fillTableFromCSV(familyTable,  FAMILY_FIELDS,  data.family);
      }catch(_e){}
    }
    $('#clear-cache').onclick = ()=>{ localStorage.removeItem('wf_cache'); alert('تم المسح'); };

    // Start
    restore();
  </script>
</body>
</html>
